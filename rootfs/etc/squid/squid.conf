# Squid default configuration with project-specific adjustments.
#
# This file builds on the upstream recommended minimum configuration and
# layers the proxy rules we ship with the image (local network ACLs,
# healthcheck allowance, logs, etc.).

# Define the local subnets we'll accept traffic from.
acl localnet src 0.0.0.1-0.255.255.255
acl localnet src 10.0.0.0/8
acl localnet src 100.64.0.0/10
acl localnet src 169.254.0.0/16
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

# Convenience ACLs for localhost and the container healthcheck.
acl localhost src 127.0.0.1/32 ::1
acl healthcheck src 127.0.0.1/32 ::1

# Allow the healthcheck to talk to cachemgr.
acl manager proto cache_object

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Deny requests to ports that are explicitly unsafe.
http_access deny !Safe_ports

# Deny CONNECT to ports other than the secure SSL ports.
http_access deny CONNECT !SSL_ports

# Allow localhost/healthcheck to use the manager interface and local proxy.
http_access allow localhost manager
http_access allow healthcheck manager
http_access allow healthcheck
http_access allow localhost
http_access allow localnet

# Prevent remote manager access unless explicitly permitted.
http_access deny manager

# Protect loopback and link-local services from remote access to them.
http_access deny to_localhost
http_access deny to_linklocal

# Block any other clients.
http_access deny all

# Squid listens on 3128 by default.
http_port 3128

# Caching and logging configuration tailored for the image.
cache allow all
cache_dir aufs /var/spool/squid 4096 16 256
cache_mem 512 MB

cache_log /var/log/squid/cache.log
access_log /var/log/squid/access.log

coredump_dir /var/cache/squid

# Refresh patterns (upstream defaults with image spacing).
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
