# Squid default configuration with project-specific adjustments.
#
# This file builds on the upstream recommended minimum configuration and
# layers the proxy rules we ship with the image (local network ACLs,
# healthcheck allowance, logs, etc.).

acl loopback_v4 src 127.0.0.1/32
acl loopback_v6 src ::1

# Define the local subnets we'll accept traffic from.
acl localnet src 10.0.0.0/8
acl localnet src 100.64.0.0/10
acl localnet src 169.254.0.0/16
acl localnet src 172.16.0.0/12
acl localnet src 192.168.0.0/16
acl localnet src fc00::/7
acl localnet src fe80::/10

acl healthcheck src 127.0.0.1/32 ::1

cache_effective_user proxy
cache_effective_group proxy

acl SSL_ports port 443
acl Safe_ports port 80          # http
acl Safe_ports port 21          # ftp
acl Safe_ports port 443         # https
acl Safe_ports port 70          # gopher
acl Safe_ports port 210         # wais
acl Safe_ports port 1025-65535  # unregistered ports
acl Safe_ports port 280         # http-mgmt
acl Safe_ports port 488         # gss-http
acl Safe_ports port 591         # filemaker
acl Safe_ports port 777         # multiling http

# Deny requests to ports that are explicitly unsafe.
http_access deny !Safe_ports

# Deny CONNECT to ports other than the secure SSL ports.
http_access deny CONNECT !SSL_ports

# Restrict manager URLs to a dedicated manager port.
acl manager proto cache_object
acl mgr_path urlpath_regex ^/squid-internal-mgr/
acl manager_port localport 3199

# Allow cache manager info queries without a password for the baked-in healthcheck
# while keeping the listener pinned to localhost on port 3199.
cachemgr_passwd none info

# Reject manager URLs arriving anywhere except the manager port listener.
http_access deny mgr_path !manager_port

# Ports
http_port [::]:3128
http_port 127.0.0.1:3199

# Allow manager requests only over the dedicated listener, but let other localhost traffic in too.
http_access allow manager_port manager
http_access allow healthcheck
http_access allow loopback_v4
http_access allow loopback_v6
http_access allow localnet

# Protect loopback and link-local services from remote access to them.
http_access deny to_localhost
http_access deny to_linklocal

# Allow optional drop-in snippets to extend/override defaults before the final deny.
include /etc/squid/conf.d/*.conf

# Block any other clients.
http_access deny all

# Caching and logging configuration tailored for the image.
cache allow all
cache_dir aufs /var/spool/squid 4096 16 256
cache_mem 512 MB

cache_log stdio:/var/log/squid/cache.log
access_log stdio:/var/log/squid/access.log

coredump_dir /var/cache/squid

# Refresh patterns (upstream defaults with image spacing).
refresh_pattern ^ftp:           1440    20%     10080
refresh_pattern -i (/cgi-bin/|\?) 0     0%      0
refresh_pattern .               0       20%     4320
